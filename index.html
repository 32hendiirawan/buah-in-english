<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buah dalam Bahasa Inggris - Leaderboard</title>
    <style>
        :root {
            --primary: #4a90e2;
            --success: #2ecc71;
            --wrong: #e74c3c;
            --bg: #f4f7f6;
            --accent: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            /* Mencegah refresh tarik-turun di Chrome Android */
            overscroll-behavior-y: contain; 
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }

        .login-box {
            background: white; padding: 2.5rem; border-radius: 20px; text-align: center;
            width: 85%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        input {
            width: 90%; padding: 12px; margin: 20px 0;
            border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; text-align: center;
        }

        .game-card {
            background: white; padding: 1.5rem; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center; width: 90%; max-width: 500px; position: relative;
        }

        .stats-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }
        .stat-item { background: #eee; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; }

        #timer.warning { color: var(--wrong); animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .word-container { display: flex; justify-content: center; gap: 6px; margin: 20px 0; flex-wrap: wrap; }
        .letter-box {
            width: 38px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-size: 1.4rem; font-weight: 800; border-bottom: 4px solid #ddd; text-transform: uppercase;
        }

        .drop-zone { border: 2px dashed var(--primary); border-radius: 8px; background: #f8fbff; }
        .drop-zone.filled { border: none; background: var(--success); color: white; transition: 0.3s; }

        .options-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; min-height: 55px; }
        .drag-item {
            width: 45px; height: 45px; background: var(--primary); color: white;
            display: flex; justify-content: center; align-items: center;
            border-radius: 10px; cursor: grab; font-size: 1.3rem; font-weight: bold;
            box-shadow: 0 4px 0 #2980b9; 
            touch-action: none; /* Penting untuk HP */
            user-select: none;
        }

        #resultModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 300; justify-content: center; align-items: center;
        }

        .modal-content {
            background: white; padding: 20px; border-radius: 20px; text-align: center;
            width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.85rem; }
        th { background: #f8f9fa; padding: 10px; border-bottom: 2px solid #eee; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .highlight { background: #fff3cd !important; font-weight: bold; border: 2px solid var(--accent); }

        .btn-action {
            padding: 12px 24px; background: var(--accent); color: white;
            border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem;
        }

        .confetti {
            position: absolute; width: 8px; height: 8px; top: -10px; z-index: 250;
            animation: fall 3s linear forwards;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color: var(--primary)">üçé Buah - Fruit</h2>
        <p>Masukkan namamu:</p>
        <input type="text" id="playerNameInput" placeholder="Nama Anda..." maxlength="12">
        <br>
        <button class="btn-action" onclick="startGame()">MULAI</button>
    </div>
</div>

<div class="game-card">
    <div class="stats-bar">
        <div class="stat-item">Soal: <span id="currentQuestion">1</span>/20</div>
        <div class="stat-item">Skor: <span id="score">0</span></div>
        <div class="stat-item">Waktu: <span id="timer">0</span>s</div>
    </div>
    <div id="pictureDisplay" style="font-size: 4rem; margin: 10px 0;"></div>
    <div class="word-container" id="wordDisplay"></div>
    <div class="options-container" id="options"></div>
    <div id="message" style="height: 20px; margin-top: 10px; font-weight: bold; color: var(--success);"></div>
</div>

<div id="resultModal">
    <div class="modal-content">
        <h2 style="margin-top: 0;">üèÜ Top 10 Global</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nama</th>
                    <th>Soal</th>
                    <th>Skor</th>
                </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
        </table>
        <button class="btn-action" onclick="resetGame()">MAIN LAGI</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyGmk8vVdWh8eXJv5A0r75g3eBP5renfesezNNTGjDPhNXTtebX1AXZ8-Zce3u8tobsOQ/exec";

    const fullData = [
        { word: "APPLE", picture: "üçé"}, { word: "ORANGE", picture: "üçä"},
        { word: "LEMON", picture: "üçã"}, { word: "BANANA", picture: "üçå"},
        { word: "WATERMELON", picture: "üçâ"}, { word: "GRAPE", picture: "üçá"},
        { word: "STRAWBERRY", picture: "üçì"}, { word: "CHERRY", picture: "üçí"},
        { word: "PEACH", picture: "üçë"}, { word: "MANGO", picture: "ü•≠"},
        { word: "PINEAPPLE", picture: "üçç"}, { word: "KIWI", picture: "ü•ù"},
        { word: "COCONUT", picture: "ü••"}, { word: "TOMATO", picture: "üçÖ"},
        { word: "MELON", picture: "üçà"}, { word: "PEAR", picture: "üçê"},
        { word: "AVOCADO", picture: "ü•ë"}, { word: "EGGPLANT", picture: "üçÜ"},
        { word: "CUCUMBER", picture: "ü•í"}, { word: "CHILI", picture: "üå∂"},
        { word: "CORN", picture: "üåΩ"}, { word: "CARROT", picture: "ü•ï"},
        { word: "POTATO", picture: "ü•î"}
    ];

    let playerName = "", sessionQuestions = [], currentIdx = 0, score = 0, answeredCorrectly = 0, timeLeft = 0;
    let timerInterval, draggedElement = null, touchItem = null;

    function startGame() {
        const input = document.getElementById('playerNameInput').value.trim();
        if (!input) return alert("Nama tidak boleh kosong!");
        playerName = input;
        document.getElementById('loginOverlay').style.display = 'none';
        initGame();
    }

    function initGame() {
        sessionQuestions = [...fullData].sort(() => Math.random() - 0.5).slice(0, 20);
        currentIdx = 0; score = 0; answeredCorrectly = 0;
        document.getElementById('score').innerText = score;
        document.getElementById('resultModal').style.display = 'none';
        loadLevel();
    }

    function loadLevel() {
        if (currentIdx >= sessionQuestions.length) return showFinalLeaderboard();
        const data = sessionQuestions[currentIdx];
        document.getElementById('currentQuestion').innerText = currentIdx + 1;
        document.getElementById('pictureDisplay').innerText = data.picture;
        document.getElementById('message').innerText = '';
        document.getElementById('wordDisplay').innerHTML = '';
        document.getElementById('options').innerHTML = '';

        timeLeft = data.word.length * 3;
        startTimer();

        data.word.split('').forEach(char => {
            const box = document.createElement('div');
            box.className = 'letter-box drop-zone';
            box.dataset.correct = char;
            document.getElementById('wordDisplay').appendChild(box);
        });

        const shuffled = data.word.split('').sort(() => Math.random() - 0.5);
        shuffled.forEach(char => {
            const item = document.createElement('div');
            item.className = 'drag-item';
            item.innerText = char;
            item.setAttribute('draggable', 'true');
            
            // Mouse Events
            item.addEventListener('dragstart', (e) => { draggedElement = item; e.dataTransfer.setData('text', char); });
            
            // Touch Events
            item.addEventListener('touchstart', handleTouchStart, {passive: false});
            item.addEventListener('touchmove', handleTouchMove, {passive: false});
            item.addEventListener('touchend', handleTouchEnd, {passive: false});
            
            document.getElementById('options').appendChild(item);
        });
    }

    function startTimer() {
        clearInterval(timerInterval);
        const el = document.getElementById('timer');
        timerInterval = setInterval(() => {
            timeLeft--;
            el.innerText = timeLeft;
            timeLeft <= 3 ? el.classList.add('warning') : el.classList.remove('warning');
            if (timeLeft <= 0) { clearInterval(timerInterval); nextLevel(); }
        }, 1000);
    }

    // --- Logika Drag & Drop (Mouse) ---
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => {
        const zone = e.target.closest('.drop-zone');
        if (zone && draggedElement && !zone.classList.contains('filled')) {
            if (draggedElement.innerText === zone.dataset.correct) {
                processCorrect(zone, draggedElement.innerText);
                draggedElement.remove();
            }
        }
    });

    // --- Logika Touch (HP) ---
    function handleTouchStart(e) {
        touchItem = e.target;
        const touch = e.touches[0];
        touchItem.style.position = 'fixed';
        touchItem.style.zIndex = '1000';
        moveAt(touch.clientX, touch.clientY);
    }

    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        const touch = e.touches[0];
        moveAt(touch.clientX, touch.clientY);
    }

    function moveAt(x, y) {
        touchItem.style.left = (x - 22) + 'px';
        touchItem.style.top = (y - 22) + 'px';
    }

    function handleTouchEnd(e) {
        if (!touchItem) return;
        const touch = e.changedTouches[0];
        touchItem.style.display = 'none'; // Sembunyikan sebentar untuk cek elemen di bawahnya
        const el = document.elementFromPoint(touch.clientX, touch.clientY);
        touchItem.style.display = 'flex';

        const zone = el ? el.closest('.drop-zone') : null;
        if (zone && !zone.classList.contains('filled') && touchItem.innerText === zone.dataset.correct) {
            processCorrect(zone, touchItem.innerText);
            touchItem.remove();
        } else {
            touchItem.style.position = 'relative';
            touchItem.style.left = '0';
            touchItem.style.top = '0';
        }
        touchItem = null;
    }

    function processCorrect(box, letter) {
        box.innerText = letter; box.classList.add('filled');
        score += 10; document.getElementById('score').innerText = score;
        const allFilled = [...document.querySelectorAll('.drop-zone')].every(z => z.classList.contains('filled'));
        if (allFilled) {
            clearInterval(timerInterval);
            answeredCorrectly++; score += timeLeft;
            document.getElementById('score').innerText = score;
            document.getElementById('message').innerText = "Hebat! üéâ";
            setTimeout(nextLevel, 800);
        }
    }

    function nextLevel() { currentIdx++; loadLevel(); }

    async function showFinalLeaderboard() {
        document.getElementById('resultModal').style.display = 'flex';
        const body = document.getElementById('leaderboardBody');
        body.innerHTML = '<tr><td colspan="4">Menyimpan skor...</td></tr>';

        const payload = { name: playerName, score: score, answered: answeredCorrectly, ts: Date.now() };

        try {
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            await new Promise(r => setTimeout(r, 1500));
            const response = await fetch(GAS_URL);
            const data = await response.json();
            
            body.innerHTML = '';
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                if (row[0] === playerName && row[1] === score) tr.className = 'highlight';
                tr.innerHTML = `<td>${index + 1}</td><td>${row[0]}</td><td>${row[2]}</td><td>${row[1]}</td>`;
                body.appendChild(tr);
            });
            createConfetti();
        } catch (e) {
            body.innerHTML = '<tr><td colspan="4">Koneksi Database Gagal.</td></tr>';
        }
    }

    function createConfetti() {
        for(let i=0; i<30; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.backgroundColor = ['#f1c40f','#e74c3c','#2ecc71','#3498db'][Math.floor(Math.random()*4)];
            c.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(c);
        }
    }

    function resetGame() { location.reload(); }
</script>
</body>
</html>
