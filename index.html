<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buah dalam Bahasa Inggris</title>
    <style>
        :root {
            --primary: #4a90e2;
            --success: #2ecc71;
            --wrong: #e74c3c;
            --bg: #f4f7f6;
            --accent: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none; 
        }

        /* Login Screen */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }

        .login-box {
            background: white; padding: 2.5rem; border-radius: 20px; text-align: center;
            width: 85%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        input {
            width: 90%; padding: 12px; margin: 20px 0;
            border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; text-align: center;
        }

        .game-card {
            background: white; padding: 2rem; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center; width: 90%; position: relative;
        }

        .stats-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }
        .stat-item { background: #eee; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; }

        #timer.warning { color: var(--wrong); animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .word-container { display: flex; justify-content: center; gap: 8px; margin: 25px 0; flex-wrap: wrap; }
        .letter-box {
            width: 42px; height: 48px; display: flex; justify-content: center; align-items: center;
            font-size: 1.6rem; font-weight: 800; border-bottom: 4px solid #ddd; text-transform: uppercase;
        }

        .drop-zone { border: 2px dashed var(--primary); border-radius: 8px; background: #f8fbff; }
        .drop-zone.filled { border: none; background: var(--success); color: white; transition: 0.3s; }

        .options-container { display: flex; justify-content: center; gap: 12px; margin-top: 25px; flex-wrap: wrap; min-height: 60px; }
        .drag-item {
            width: 48px; height: 48px; background: var(--primary); color: white;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px; cursor: grab; font-size: 1.4rem; font-weight: bold;
            box-shadow: 0 4px 0 #2980b9; touch-action: none;
        }

        /* Leaderboard Modal */
        #resultModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 100; justify-content: center; align-items: center;
        }

        .modal-content {
            background: white; padding: 25px; border-radius: 20px; text-align: center;
            width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .highlight { background: #fff3cd !important; font-weight: bold; border: 2px solid var(--accent); }

        .btn-action {
            padding: 14px 28px; background: var(--accent); color: white;
            border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem;
        }

        .confetti {
            position: absolute; width: 8px; height: 8px; top: -10px; z-index: 99;
            animation: fall 3s linear forwards;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color: var(--primary)">üçé Buah - Fruit</h2>
        <p>Masukkan namamu:</p>
        <input type="text" id="playerNameInput" placeholder="Contoh: Budi" maxlength="12">
        <br>
        <button class="btn-action" onclick="startGame()">MULAI PERMAINAN</button>
    </div>
</div>

<div class="game-card">
    <div class="stats-bar">
        <div class="stat-item">Soal: <span id="currentQuestion">1</span>/20</div>
        <div class="stat-item">Skor: <span id="score">0</span></div>
        <div class="stat-item">Waktu: <span id="timer">0</span>s</div>
    </div>
    <div id="pictureDisplay" style="font-size: 4rem; margin: 10px 0;"></div>
    <div class="word-container" id="wordDisplay"></div>
    <div class="options-container" id="options"></div>
    <div id="message" style="height: 20px; margin-top: 10px; font-weight: bold;"></div>
</div>

<div id="resultModal">
    <div class="modal-content">
        <h2 style="margin-top: 0;">üèÜ Top 10 Global</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nama</th>
                    <th>Soal</th>
                    <th>Skor</th>
                </tr>
            </thead>
            <tbody id="leaderboardBody">
                <tr><td colspan="4">Menyambungkan ke database...</td></tr>
            </tbody>
        </table>
        <button class="btn-action" onclick="resetGame()">MAIN LAGI</button>
    </div>
</div>

<script>
    // GANTI DENGAN URL WEB APP GAS ANDA
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyGmk8vVdWh8eXJv5A0r75g3eBP5renfesezNNTGjDPhNXTtebX1AXZ8-Zce3u8tobsOQ/exec";

    const fullData = [
        { word: "APPLE", picture: "üçé"},
        { word: "ORANGE", picture: "üçä"},
        { word: "LEMON", picture: "üçã"},
        { word: "BANANA", picture: "üçå"},
        { word: "WATERMELON", picture: "üçâ"},
        { word: "GRAPE", picture: "üçá"},
        { word: "STRAWBERRY", picture: "üçì"},
        { word: "CHERRY", picture: "üçí"},
        { word: "PEACH", picture: "üçë"},
        { word: "MANGO", picture: "ü•≠"},
        { word: "PINEAPPLE", picture: "üçç"},
        { word: "KIWI", picture: "ü•ù"},
        { word: "COCONUT", picture: "ü••"},
        { word: "TOMATO", picture: "üçÖ"},
        { word: "MELON", picture: "üçà"},
        { word: "PEAR", picture: "üçê"},
        { word: "AVOCADO", picture: "ü•ë"},
        { word: "EGGPLANT", picture: "üçÜ"},
        { word: "CUCUMBER", picture: "ü•í"},
        { word: "CHILI", picture: "üå∂"},
        { word: "CORN", picture: "üåΩ"},
        { word: "CARROT", picture: "ü•ï"},
        { word: "POTATO", picture: "ü•î"},
    ];

    let playerName = "";
    let sessionQuestions = [];
    let currentIdx = 0, score = 0, answeredCorrectly = 0, timeLeft = 0, sessionTimestamp = 0;
    let timerInterval, draggedElement = null;

    function startGame() {
        const input = document.getElementById('playerNameInput').value.trim();
        if (!input) return alert("Nama tidak boleh kosong!");
        playerName = input;
        document.getElementById('loginOverlay').style.display = 'none';
        initGame();
    }

    function initGame() {
        sessionQuestions = [...fullData].sort(() => Math.random() - 0.5).slice(0, 20);
        currentIdx = 0; score = 0; answeredCorrectly = 0;
        document.getElementById('score').innerText = score;
        document.getElementById('resultModal').style.display = 'none';
        document.querySelectorAll('.confetti').forEach(c => c.remove());
        loadLevel();
    }

    function loadLevel() {
        if (currentIdx >= sessionQuestions.length) return showFinalLeaderboard();
        
        const data = sessionQuestions[currentIdx];
        document.getElementById('currentQuestion').innerText = currentIdx + 1;
        document.getElementById('pictureDisplay').innerText = data.picture;
        document.getElementById('message').innerText = '';
        document.getElementById('wordDisplay').innerHTML = '';
        document.getElementById('options').innerHTML = '';

        timeLeft = data.word.length * 3;
        startTimer();

        data.word.split('').forEach(char => {
            const box = document.createElement('div');
            box.className = 'letter-box drop-zone';
            box.dataset.correct = char;
            box.addEventListener('dragover', e => e.preventDefault());
            box.addEventListener('drop', handleDrop);
            document.getElementById('wordDisplay').appendChild(box);
        });

        const shuffled = data.word.split('').sort(() => Math.random() - 0.5);
        shuffled.forEach((char, i) => {
            const item = document.createElement('div');
            item.className = 'drag-item';
            item.innerText = char;
            item.setAttribute('draggable', 'true');
            item.addEventListener('dragstart', (e) => { draggedElement = item; e.dataTransfer.setData('text', char); });
            item.addEventListener('touchstart', handleTouchStart, {passive: false});
            item.addEventListener('touchmove', handleTouchMove, {passive: false});
            item.addEventListener('touchend', handleTouchEnd, {passive: false});
            document.getElementById('options').appendChild(item);
        });
    }

    function startTimer() {
        clearInterval(timerInterval);
        updateTimerUI();
        timerInterval = setInterval(() => {
            timeLeft--; updateTimerUI();
            if (timeLeft <= 0) { clearInterval(timerInterval); nextLevel(); }
        }, 1000);
    }

    function updateTimerUI() {
        const el = document.getElementById('timer');
        el.innerText = timeLeft;
        timeLeft <= 3 ? el.classList.add('warning') : el.classList.remove('warning');
    }

    function handleDrop(e) {
        e.preventDefault();
        const letter = e.dataTransfer.getData('text');
        if (letter === e.target.dataset.correct && !e.target.classList.contains('filled')) {
            processCorrect(e.target, letter);
            if (draggedElement) draggedElement.remove();
        }
    }

    function processCorrect(box, letter) {
        box.innerText = letter; box.classList.add('filled');
        score += 10; document.getElementById('score').innerText = score;
        checkWin();
    }

    function checkWin() {
        const zones = document.querySelectorAll('.drop-zone');
        const filled = document.querySelectorAll('.drop-zone.filled');
        if (zones.length === filled.length) {
            clearInterval(timerInterval);
            answeredCorrectly++; score += timeLeft;
            document.getElementById('score').innerText = score;
            document.getElementById('message').innerText = "Hebat! üéâ";
            setTimeout(nextLevel, 1000);
        }
    }

    function nextLevel() { currentIdx++; loadLevel(); }

    async function showFinalLeaderboard() {
        document.getElementById('resultModal').style.display = 'flex';
        const body = document.getElementById('leaderboardBody');
        body.innerHTML = '<tr><td colspan="4">Mengirim skor & memuat data...</td></tr>';

        sessionTimestamp = Date.now();
        const payload = {
            name: playerName,
            score: score,
            answered: answeredCorrectly,
            ts: sessionTimestamp
        };

        try {
            // 1. Kirim Skor
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // Untuk menghindari masalah CORS pada GAS
                cache: 'no-cache',
                body: JSON.stringify(payload)
            });

            // Delay sedikit agar GAS selesai memproses append baris
            await new Promise(r => setTimeout(r, 1500));

            // 2. Ambil Data
            const response = await fetch(GAS_URL);
            const data = await response.json();
            
            body.innerHTML = '';
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                // Row format dari GAS: [Nama, Skor, Soal, Timestamp]
                // Cek kesamaan nama dan skor untuk highlight (atau TS jika tersedia)
                if (row[0] === playerName && row[1] === score) tr.className = 'highlight';
                
                tr.innerHTML = `<td>${index + 1}</td><td>${row[0]}</td><td>${row[2]}</td><td>${row[1]}</td>`;
                body.appendChild(tr);
            });
            createConfetti();

        } catch (e) {
            body.innerHTML = '<tr><td colspan="4">Gagal terhubung ke database. Cek koneksi Anda.</td></tr>';
        }
    }

    function createConfetti() {
        for(let i=0; i<40; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.backgroundColor = ['#f1c40f','#e74c3c','#2ecc71','#3498db'][Math.floor(Math.random()*4)];
            c.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(c);
        }
    }

    function resetGame() { initGame(); }

    // Touch Support
    let touchItem = null;
    function handleTouchStart(e) { 
        touchItem = e.target; 
        touchItem.style.position = 'fixed'; 
        touchItem.style.zIndex = '1000'; 
    }
    function handleTouchMove(e) { 
        e.preventDefault(); 
        const t = e.touches[0]; 
        touchItem.style.left = t.pageX - 24 + 'px'; 
        touchItem.style.top = t.pageY - 24 + 'px'; 
    }
    function handleTouchEnd(e) {
        const t = e.changedTouches[0]; 
        const el = document.elementFromPoint(t.clientX, t.clientY);
        if (el && el.classList.contains('drop-zone') && touchItem.innerText === el.dataset.correct && !el.classList.contains('filled')) {
            processCorrect(el, touchItem.innerText); 
            touchItem.remove();
        } else { 
            touchItem.style.position = 'relative'; 
            touchItem.style.left = '0'; 
            touchItem.style.top = '0'; 
        }
        touchItem = null;
    }
</script>
</body>

</html>


